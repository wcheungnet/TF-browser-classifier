<html>

<head>
    <!-- Load the latest version of TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <!-- Load MobileNet -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <!-- Load KNN Classifier -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier"></script>
    <style>
        img {
            width: 300px;
        }
    </style>
</head>

<body>
    <div id="console"></div>

    <video playsinline muted id="webcam" width="320" height="240" src="BigBuckBunny_320.mp4"></video>
    <script>

        let net;
        const webcamElement = document.getElementById('webcam');
        const classifier = knnClassifier.create();

        async function app() {

            console('Loading mobilenet..');

            // Load the model.
            net = await mobilenet.load();

            // await setupWebcam();

            // Reads an image from the webcam and associates it with a specific class
            // index.

            const addExample = async (classId, time) => {
                webcamElement.currentTime = time;
                console(classId + " Adding");
                await sleep(.1);
                const myActivation = net.infer(webcamElement, 'conv_preds');
                classifier.addExample(myActivation, classId);
            };

            await addExample("bird", 18.1);
            await addExample("bird", 18.2);
            await addExample("bird", 18.3);
            await addExample("bird", 18.4);
            await addExample("bird", 18.5);
            await addExample("bird", 19);
            await addExample("bird", 19.1);
            await addExample("bird", 19.2);
            await addExample("bird", 19.3);

            await addExample("butterfly", 186);
            await addExample("butterfly", 184);
            await addExample("butterfly", 182);
            await addExample("butterfly", 183);

            await addExample("bunny", 60);
            await addExample("bunny", 61);
            await addExample("bunny", 62);
            await addExample("bunny", 63);

            webcamElement.currentTime = 0;
            webcamElement.play();

            while (true) {
                if (classifier.getNumClasses() > 0) {
                    // Get the activation from mobilenet from the webcam.
                    const activation = net.infer(webcamElement, 'conv_preds');

                    // Get the most likely class and confidences from the classifier module.
                    const result = await classifier.predictClass(activation);

                    const classes = ['bird', 'butterfly', 'bunny'];
                    document.getElementById('console').innerText = `
                        prediction: ${classes[result.classIndex]}\n
                        probability: ${Math.round(result.confidences[result.label] * 100)}%
                    `;
                }
                await tf.nextFrame();
            }
        }

        async function sleep(time) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    return resolve(true);
                }, time * 1000);
            })
        }

        function console(string) {
            document.getElementById('console').innerHTML = string;
        }

        async function loadLocalImage(filename, sampleName) {
            return new Promise((resolve) => {
                try {
                    const img = new Image()
                    img.onload = () => {
                        ctx.drawImage(img, 0, 0);
                        let image = tf.browser.fromPixels(canvas);
                        console.log(image);
                        const activation = net.infer(img, 'conv_preds');
                        console.log(activation);
                        classifier.addExample(activation, sampleName);
                        return resolve(null);
                    }
                    img.onerror = err => { throw err };
                    img.src = filename;

                } catch (err) {
                    console.log(err);
                }
            })
        }

        app();

    </script>
</body>

</html>